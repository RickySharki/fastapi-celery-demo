<!DOCTYPE html>
<html>
<head>
    <title>AI任务批处理系统</title>
    <style>
        .task-list {
            margin: 20px;
        }
        .task-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .task-item.PENDING { background-color: #fff3cd; }
        .task-item.STARTED, .task-item.RUNNING { background-color: #cce5ff; }
        .task-item.SUCCESS, .task-item.COMPLETED { background-color: #d4edda; }
        .task-item.FAILURE, .task-item.FAILED { background-color: #f8d7da; }
        .control-panel {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 10px;
            color: white;
        }
        .progress-bar {
            margin: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .progress {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-value {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .flower-link {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        .flower-link:hover {
            background-color: #218838;
        }
        .tab-container {
            margin: 20px;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 0 4px 4px 4px;
        }
        .tab-content.active {
            display: block;
        }
        .flower-container {
            width: 100%;
        }
        .worker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .worker-table th, .worker-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .worker-table th {
            background-color: #f2f2f2;
        }
        .refresh-button {
            margin-top: 10px;
            background-color: #6c757d;
        }
        .refresh-button:hover {
            background-color: #5a6268;
        }
        .error {
            color: #721c24;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('tasks')">任务管理</button>
            <button class="tab-button" onclick="showTab('monitor')">Worker监控</button>
            <a href="/flower-status" target="_blank" class="tab-button">详细监控</a>
        </div>
        
        <div id="tasks-tab" class="tab-content active">
            <div class="control-panel">
                <h2>AI任务批处理控制面板</h2>
                <button onclick="createBatchTasks(50)" id="batchButton">创建50个AI任务</button>
                <button onclick="clearTasks()" id="clearButton">清除所有任务</button>
                <button onclick="resetWorkers()" id="resetButton">重置Worker</button>
                <button onclick="pauseWorkers()" id="pauseButton">暂停Worker</button>
                <button onclick="resumeWorkers()" id="resumeButton">恢复Worker</button>
            </div>

            <div class="progress-bar">
                <h3>任务进度</h3>
                <div class="progress">
                    <div class="progress-value" id="progressBar" style="width: 0%"></div>
                </div>
                <p id="progressText">完成: 0/0 (0%)</p>
            </div>

            <div class="task-list" id="taskList">
                <h3>任务状态实时监控</h3>
            </div>
        </div>
        
        <div id="monitor-tab" class="tab-content">
            <div class="flower-container">
                <h2>Celery Flower 监控</h2>
                <p>请使用以下凭据登录Flower监控：</p>
                <ul>
                    <li><strong>用户名</strong>: admin</li>
                    <li><strong>密码</strong>: admin</li>
                </ul>
                <a href="http://localhost:5555" target="_blank" class="flower-link">
                    在新窗口打开Flower监控
                </a>
                
                <div class="flower-status">
                    <h3>Worker状态摘要</h3>
                    <div id="workerStatus">加载中...</div>
                    <button onclick="refreshWorkerStatus()" class="refresh-button">刷新状态</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource;
        let tasksCount = 0;

        function connectEventSource() {
            console.log("开始连接SSE...");
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/tasks/stream');
            
            // 连接成功事件
            eventSource.addEventListener('connected', function(event) {
                console.log("SSE连接成功");
            });
            
            // 更新事件
            eventSource.addEventListener('update', function(event) {
                console.log("收到SSE更新事件:", event.data);
                try {
                    const data = JSON.parse(event.data);
                    if (data.tasks && Array.isArray(data.tasks)) {
                        updateTaskList(data.tasks);
                        updateProgress(data.tasks);
                    } else {
                        console.warn("收到的任务数据格式不正确:", data);
                    }
                } catch (error) {
                    console.error("解析SSE数据失败:", error, event.data);
                }
            });
            
            // 默认消息处理
            eventSource.onmessage = function(event) {
                console.log("收到未命名SSE消息:", event.data);
            };

            // 打开连接事件
            eventSource.onopen = function(event) {
                console.log("SSE连接已打开");
            };

            // 错误处理
            eventSource.onerror = function(error) {
                console.error("SSE连接错误:", error);
                eventSource.close();
                console.log("5秒后尝试重新连接...");
                setTimeout(connectEventSource, 5000);
            };
        }

        function updateProgress(tasks) {
            if (tasks.length === 0) return;
            
            const completed = tasks.filter(t => 
                t.status === 'SUCCESS' || t.status === 'COMPLETED' || 
                t.status === 'FAILURE' || t.status === 'FAILED'
            ).length;
            
            const progress = (completed / tasks.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `完成: ${completed}/${tasks.length} (${progress.toFixed(1)}%)`;
        }

        function updateTaskList(tasks) {
            const taskList = document.getElementById('taskList');
            let html = '<h3>任务状态实时监控</h3>';
            
            tasks.sort((a, b) => a.name.localeCompare(b.name)).forEach(task => {
                const statusColor = getStatusColor(task.status);
                html += `
                    <div class="task-item ${task.status}">
                        <h4>${task.name}
                            <span class="status-badge" style="background-color: ${statusColor};">
                                ${task.status}
                            </span>
                        </h4>
                        <p>ID: ${task.id}</p>
                        <p>结果: ${task.result || '处理中...'}</p>
                    </div>
                `;
            });
            
            taskList.innerHTML = html;
        }

        function getStatusColor(status) {
            const colors = {
                'PENDING': '#856404',
                'STARTED': '#004085',
                'RUNNING': '#004085',
                'SUCCESS': '#155724',
                'COMPLETED': '#155724',
                'FAILURE': '#721c24',
                'FAILED': '#721c24'
            };
            return colors[status] || '#666';
        }

        async function createBatchTasks(num) {
            const button = document.getElementById('batchButton');
            button.disabled = true;
            
            try {
                const response = await fetch(`/tasks/concurrent/${num}`, {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('批量任务创建成功:', data);
                tasksCount = num;
            } catch (error) {
                console.error('创建任务失败:', error);
                alert('创建任务失败，请查看控制台了解详情');
            } finally {
                button.disabled = false;
            }
        }

        async function clearTasks() {
            const button = document.getElementById('clearButton');
            button.disabled = true;
            
            try {
                // 调用后端清除接口
                const response = await fetch('/tasks/clear', {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('清除任务成功:', data);
                
                // 清除前端显示
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = '<h3>任务状态实时监控</h3>';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressText').textContent = '完成: 0/0 (0%)';
                tasksCount = 0;
            } catch (error) {
                console.error('清除任务失败:', error);
                alert('清除任务失败，请查看控制台了解详情');
            } finally {
                button.disabled = false;
            }
        }

        async function resetWorkers() {
            if (!confirm("确定要重置所有Worker吗？这将终止所有正在执行的任务。")) return;
            
            const button = document.getElementById('resetButton');
            button.disabled = true;
            
            try {
                const response = await fetch('/tasks/reset-queue', {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('重置Worker成功:', data);
                alert(data.message);
            } catch (error) {
                console.error('重置Worker失败:', error);
                alert('重置Worker失败，请查看控制台了解详情');
            } finally {
                button.disabled = false;
            }
        }
        
        async function pauseWorkers() {
            // 实现暂停Worker的逻辑
        }
        
        async function resumeWorkers() {
            // 实现恢复Worker的逻辑
        }

        // 页面加载时连接SSE
        connectEventSource();

        // 添加标签页切换功能
        function showTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 取消所有标签按钮的激活状态
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 激活对应的按钮
            event.currentTarget.classList.add('active');
        }

        // 添加获取Worker状态的函数
        async function refreshWorkerStatus() {
            try {
                const response = await fetch('/worker-status');
                const data = await response.json();
                
                let html = '<table class="worker-table">';
                html += '<tr><th>Worker名称</th><th>状态</th><th>活跃任务</th><th>已处理任务</th></tr>';
                
                for (const worker of data.workers) {
                    html += `
                        <tr>
                            <td>${worker.name}</td>
                            <td>${worker.status}</td>
                            <td>${worker.active_tasks}</td>
                            <td>${worker.processed}</td>
                        </tr>
                    `;
                }
                
                html += '</table>';
                document.getElementById('workerStatus').innerHTML = html;
            } catch (error) {
                console.error('获取Worker状态失败:', error);
                document.getElementById('workerStatus').innerHTML = 
                    '<p class="error">获取Worker状态失败，请直接打开Flower监控查看详情</p>';
            }
        }
        
        // 页面加载时获取一次状态
        refreshWorkerStatus();
    </script>
</body>
</html> 